# خطة تنفيذ جميع المتطلبات المتبقية

## ملخص المتطلبات  
التاكد من تسجيل الدخول ومن ثم

تنفيذ 4 مجموعات من التحسينات دفعة واحدة:

1. **إدارة المناهج الذكية** - التعديل المباشر، الانتقال التلقائي، تفاعل العروض
2. **نظام المهام التفاعلي** - دورة العمل، تفاصيل المهمة، إعادة العمل والترقية
3. **الموارد البشرية والقرار الإداري** - سجل مقدم الطلب، زر التراجع
4. **إدارة المستخدمين** - تعديل البيانات، إعادة تعيين كلمات المرور، سجل النشاط

---

## 1. إدارة المناهج (Curricula.tsx)

### التعديل المباشر للمناهج

- إضافة زر "تعديل" لكل منهاج في الجدول وفي عرض المراحل
- فتح نافذة حوار (Dialog) تحتوي على جميع حقول المنهاج مملوءة بالبيانات الحالية
- حفظ التعديلات مباشرة إلى قاعدة البيانات

### الانتقال التلقائي بين المراحل

- عند حفظ/تعديل منهاج، يتم فحص الحقول المطلوبة لكل مرحلة تلقائيا
- إذا استوفى المنهاج شروط المرحلة التالية، ينتقل تلقائيا بدون تدخل يدوي
- منطق المراحل: form (يتطلب form_type) -> audit (يتطلب audit_status=done) -> printed (يتطلب is_printed) -> completed

### تفاعل دياجرام العروض

- عند الضغط على أي مرحلة في دياجرام العروض، يتم عرض قائمة المناهج ضمن تلك المرحلة (نفس منطق دياجرام المناهج)

---

## 2. نظام المهام التفاعلي (Tasks.tsx)

### دورة العمل المحسّنة

- **المكلّف**: assigned -> in_progress -> under_review (موجود حاليا)
- **المنشئ بعد المراجعة**: 
  - اعتماد (approved) مع تحديد نقاط
  - إعادة للتعديل (assigned) - يعيد المهمة للمكلف
  - ترقية المهمة (تحديث النقاط)

### نافذة تفاصيل المهمة

- عند الضغط على أي مهمة، تفتح نافذة حوار تعرض:
  - اسم المكلّف (من جدول profiles)
  - اسم منشئ المهمة
  - نص المهمة والوصف
  - الحالة الحالية
  - المدة الزمنية المنقضية منذ التكليف
  - ملاحظات الإنجاز والمراجعة

### تحسين إجراءات المنشئ

- إضافة حقل نقاط عند الموافقة (بدلا من نقطة واحدة ثابتة)
- إضافة زر "إعادة للتعديل" مع ملاحظات

---

## 3. الموارد البشرية (HR.tsx)

### سجل مقدم الطلب (Contextual Approval)

- قبل الموافقة/الرفض، عرض بطاقة تفصيلية للمقدم تشمل:
  - الرصيد المتبقي (أيام إجازة وساعات زمنية)
  - سجل الشهر الحالي (هل أخذ إجازة/زمنية/واجب سابقا؟)
- يتم جلب البيانات من leave_balances + leave_requests للشهر الحالي

### زر التراجع

- إضافة زر "تراجع" للمدير/مسؤول الشعبة
- يظهر على القرارات المتخذة مسبقا (موافقة أو رفض)
- يعيد الطلب للحالة "معلّق" (pending) ويمسح بيانات القرار

---

## 4. إدارة المستخدمين (UserManagement.tsx)

### تعديل بيانات العضو

- إضافة زر "تعديل" لكل عضو في الجدول
- نافذة حوار لتعديل: الاسم، الشعبة، نظام الدوام، الهاتف، الدور

### إعادة تعيين كلمة المرور

- إنشاء edge function جديدة `reset-user-password` تستخدم admin API
- إضافة زر "إعادة تعيين كلمة المرور" في واجهة التعديل

### سجل النشاط (Audit Log)

- إضافة تبويب "سجل النشاط" في صفحة إدارة المستخدمين
- عرض آخر الحركات من جدول audit_log مع تفاصيل الإجراء والوقت
- تسجيل تلقائي لكل عملية (تعديل بيانات، إعادة تعيين كلمة مرور)

---

## التفاصيل التقنية

### قاعدة البيانات

- لا حاجة لتعديلات على الجداول - الهيكل الحالي يدعم جميع المتطلبات
- جدول `audit_log` موجود بالفعل ويدعم التسجيل
- جدول `leave_balances` موجود لعرض الأرصدة

### Edge Function جديدة

- `reset-user-password`: تستقبل user_id وpassword جديدة، تتحقق أن المتصل admin، وتستخدم `adminClient.auth.admin.updateUserById`

### الملفات المتأثرة


| الملف                                             | التغييرات                                |
| ------------------------------------------------- | ---------------------------------------- |
| `src/pages/Curricula.tsx`                         | تعديل مباشر، انتقال تلقائي، تفاعل العروض |
| `src/pages/Tasks.tsx`                             | تفاصيل المهمة، إعادة للتعديل، نقاط مخصصة |
| `src/pages/HR.tsx`                                | سجل المقدم، زر التراجع                   |
| `src/pages/UserManagement.tsx`                    | تعديل، إعادة تعيين كلمة مرور، سجل نشاط   |
| `supabase/functions/reset-user-password/index.ts` | edge function جديدة                      |
| `supabase/functions/create-user/index.ts`         | بدون تغيير                               |


### ترتيب التنفيذ

1. إنشاء edge function لإعادة تعيين كلمة المرور
2. تحديث جميع الصفحات الأربع بالتوازي
3. لا حاجة لـ migration جديدة