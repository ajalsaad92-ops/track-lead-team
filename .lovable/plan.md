

# خطة التنفيذ: إدارة المستخدمين + ملف الموظف + التقارير المتقدمة

---

## الجزء 1: تحسين وحدة إدارة المستخدمين (UserManagement.tsx)

### 1.1 شفافية الإنشاء (Live Preview)
- عند إنشاء حساب جديد بنجاح، بدلاً من إغلاق الحوار فقط، يتم إبراز الصف الجديد في الجدول بلون مميز (highlight) لبضع ثوانٍ ليرى المدير الحساب المضاف فوراً.

### 1.2 تعطيل/تفعيل الحساب
- إضافة عمود `is_disabled` (boolean, default false) إلى جدول `profiles` عبر migration.
- إضافة زر "تعطيل/تفعيل" في عمود الإجراءات بجانب أزرار التعديل وكلمة المرور.
- عند التعطيل يتم تحديث `is_disabled = true` ويظهر شارة "معطّل" بجانب اسم المستخدم.

---

## الجزء 2: ملف الموظف الشامل في الموارد البشرية (HR.tsx)

### 2.1 تبويب "عرض المستخدمين" جديد
- إضافة تبويب ثالث في صفحة HR باسم "عرض المستخدمين" يظهر لأدوار admin و unit_head.
- يعرض قائمة الموظفين مع فلتر حسب الشعبة.

### 2.2 صفحة/حوار الملف الشخصي المتكامل (User Dossier)
- عند الضغط على اسم موظف، يفتح حوار (Dialog) كبير يجمع بياناته من كافة الجداول:
  - **موقف الحضور**: استعلام جدول `attendance` + `leave_balances` لعرض ملخص (حضور، إجازات مستهلكة/متبقية، زمنيات، غياب).
  - **سجل المهام**: استعلام جدول `tasks` حيث `assigned_to = user_id` مع عرض الحالة (مكتملة، قيد التنفيذ، متأخرة عبر مقارنة `due_date` بالتاريخ الحالي).
  - **سجل الإنجازات**: استعلام جدول `curricula` حيث `created_by = user_id` لعرض المناهج المنشأة أو المكتملة.
  - **إحصائيات النقاط**: مجموع `points_awarded` من جدول `tasks` حيث `status = 'approved'`.

---

## الجزء 3: نظام التقارير المتقدم (Reports.tsx)

### 3.1 إعادة هيكلة الصفحة إلى 3 تبويبات
يتم تقسيم صفحة التقارير الحالية إلى ثلاثة تبويبات (Tabs):

#### التبويب 1: تقارير الحضور والانضباط
- إضافة فلتر فترة زمنية (يومي/أسبوعي/شهري) بجانب فلاتر الشعبة والنظام الموجودة.
- الجدول الحالي يبقى كما هو مع إضافة عمود "نسبة الالتزام" (حضور / إجمالي أيام العمل).

#### التبويب 2: تقارير إنتاجية الشعب
- رسم بياني (BarChart) باستخدام Recharts يقارن بين الشعبتين من حيث:
  - عدد المهام المنجزة vs المتأخرة.
  - عدد المناهج المكتملة.
- جدول تفصيلي أسفل الرسم.

#### التبويب 3: لوحة التميز (Leaderboard)
- ترتيب الموظفين حسب النقاط (من `tasks.points_awarded` حيث `status = 'approved'`).
- عرض كجدول مرتب مع ميداليات (ذهبي، فضي، برونزي) لأول 3.
- إمكانية الطباعة.

---

## التفاصيل التقنية

### Database Migration المطلوبة
```sql
ALTER TABLE public.profiles ADD COLUMN is_disabled boolean NOT NULL DEFAULT false;
```

### الملفات التي ستُعدّل
| الملف | التغييرات |
|---|---|
| `src/pages/UserManagement.tsx` | إضافة زر تعطيل/تفعيل، تأثير highlight للصف الجديد |
| `src/pages/HR.tsx` | إضافة تبويب "عرض المستخدمين" + حوار الملف الشخصي المتكامل |
| `src/pages/Reports.tsx` | إعادة هيكلة إلى 3 تبويبات + رسوم بيانية + Leaderboard |

### الملفات الجديدة
| الملف | الوصف |
|---|---|
| `src/components/hr/UserDossier.tsx` | مكون الملف الشخصي المتكامل |
| `src/components/reports/AttendanceReport.tsx` | تبويب تقارير الحضور |
| `src/components/reports/ProductivityReport.tsx` | تبويب إنتاجية الشعب مع الرسم البياني |
| `src/components/reports/Leaderboard.tsx` | تبويب لوحة التميز |

### لا حاجة لتغيير RLS
- جميع الاستعلامات تعمل ضمن سياسات RLS الحالية (admin يرى الكل، unit_head يرى شعبته).
- عمود `is_disabled` في profiles يتبع سياسة "Admin full access profiles" الموجودة.

